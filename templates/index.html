<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatForge</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.17/lib/marked.umd.min.js"></script>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body class="light-theme">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar expanded" id="sidebar">
            <div class="sidebar-content">
                <!-- Header -->
                <div class="sidebar-header">
                    <div class="brand" onclick="toggleSidebar()">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="ChatForge" style="width: 32px; height: 32px; border-radius: 8px;">
                        <span class="brand-name">ChatForge</span>
                    </div>
                    <button class="btn-toggle" onclick="toggleSidebar()" title="Hide sidebar">
                        <i class="fas fa-angles-left"></i>
                    </button>
                </div>
                
                <!-- New Chat -->
                <button class="btn-new-chat" onclick="newChat()">
                    <i class="fas fa-plus"></i>
                    <span>New Chat</span>
                </button>
                
                <!-- History -->
                <div class="chat-history" id="chatHistory"></div>
                
                <!-- Footer -->
                <div class="sidebar-footer" id="sidebarFooter">
                    <button class="btn-sidebar-item" onclick="openSettings()">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <button class="btn-menu" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="top-bar-right">
                    <div class="credits-badge">
                        <i class="fas fa-coins"></i>
                        <span id="creditsCount">10</span>
                    </div>
                    
                    <button class="btn-theme" onclick="toggleTheme()" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <div class="dropdown" id="userDropdown">
                        <button class="btn-user" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" id="userDropdownMenu">
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chatContainer" onscroll="handleScroll()">
                <div class="welcome-screen" id="welcomeScreen">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="ChatForge" style="width: 170px; margin-top: 85px; border-radius: 16px; margin-bottom: 24px;">
                    <h1>Welcome to ChatForge</h1>
                    <p>Start a conversation with AI</p>
                    
                    <div class="quick-prompts">
                        <div class="prompt-card" onclick="quickStart('Explain quantum computing')">
                            <i class="fas fa-atom"></i>
                            <span>Quantum Computing</span>
                        </div>
                        <div class="prompt-card" onclick="quickStart('Write Python code')">
                            <i class="fab fa-python"></i>
                            <span>Code Helper</span>
                        </div>
                        <div class="prompt-card" onclick="quickStart('Creative writing tips')">
                            <i class="fas fa-pen"></i>
                            <span>Writing Tips</span>
                        </div>
                        <div class="prompt-card" onclick="quickStart('Data analysis help')">
                            <i class="fas fa-chart-bar"></i>
                            <span>Data Analysis</span>
                        </div>
                        <div class="prompt-card" onclick="quickStart('Explain machine learning')">
                            <i class="fas fa-brain"></i>
                            <span>Machine Learning</span>
                        </div>
                        <div class="prompt-card" onclick="quickStart('Help with math problems')">
                            <i class="fas fa-calculator"></i>
                            <span>Math Helper</span>
                        </div>
                    </div>
                </div>
                
                <div class="messages" id="messages"></div>
            </div>
            <!-- Scroll Button -->
            <button class="btn-scroll" id="scrollBtn" onclick="scrollToBottom()" style="display:none;">
                <i class="fas fa-arrow-down"></i>
            </button>

            <!-- Input Area -->
            <div class="input-area">
                
                <div class="input-box">
                    <!-- File Preview -->
                    <div id="filePreview" class="file-preview"></div>
                    
                    <!-- Main Input -->
                    <div class="input-main">
                        <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload()" accept="image/*,.pdf,.txt,.doc,.docx">
                        <div class="input-content" contenteditable="true" id="messageInput" data-placeholder="Ask anything..."></div>
                        <button class="btn-send" onclick="sendMessage()" id="sendBtn">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                    
                    <!-- Footer: Actions -->
                    <div class="input-footer">
                        <button class="footer-btn" onclick="toggleProviderSelector()" title="Choose provider" id="providerBtn">
                            <i class="fas fa-building"></i>
                        </button>
                        <button class="footer-btn" onclick="toggleModelSelector()" title="Choose model" id="modelBtn">
                            <i class="fas fa-microchip"></i>
                        </button>
                    </div>
                    
                    <!-- Provider Selector Dropdown -->
                    <div class="selector-dropdown" id="providerSelector" style="display:none;">
                        <div class="selector-header">Choose Provider</div>
                        <div class="selector-list" id="providerList"></div>
                    </div>
                    
                    <!-- Model Selector Dropdown -->
                    <div class="selector-dropdown" id="modelSelector" style="display:none;">
                        <div class="selector-header">Choose Model</div>
                        <div class="selector-list" id="modelList"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="settings-layout">
                        <div class="settings-nav">
                            <button class="settings-nav-item active" onclick="showTab('personalization')">
                                <i class="fas fa-user-cog"></i> Personalization
                            </button>
                            <button class="settings-nav-item" onclick="showTab('privacy')">
                                <i class="fas fa-shield-alt"></i> Privacy
                            </button>
                            <button class="settings-nav-item" onclick="showTab('upgrade')">
                                <i class="fas fa-crown"></i> Upgrade
                            </button>
                        </div>
                        
                        <div class="settings-content">
                            <div class="settings-tab active" id="personalization">
                                <h6>Personalization</h6>
                                <div class="mb-3">
                                    <label>Nickname</label>
                                    <input type="text" class="form-control" id="nicknameInput" placeholder="Your nickname">
                                    <small style="color: var(--text-2);">AI will address you by this name</small>
                                </div>
                                <div class="mb-3">
                                    <label>System Prompt</label>
                                    <textarea class="form-control" id="systemPromptInput" rows="3" placeholder="Custom instructions for AI behavior..."></textarea>
                                    <small style="color: var(--text-2);">Define how AI should respond to you</small>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="savePersonalization()">
                                        <i class="fas fa-save me-2"></i>Save
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="optimizePrompt()">
                                        <i class="fas fa-magic me-2"></i>Optimize
                                    </button>
                                </div>
                            </div>
                            
                            <div class="settings-tab" id="privacy">
                                <h6>Privacy</h6>
                                <p>Your data is secure and private.</p>
                                <div style="display: flex; gap: 10px;">
                                    <a href="/privacy" class="btn btn-outline-primary">View Policy</a>
                                    <a href="/docs" class="btn btn-outline-primary">Documentation</a>
                                </div>
                            </div>
                            
                            <div class="settings-tab" id="upgrade">
                                <h6>Upgrade Plan</h6>
                                <p>Get more credits and features.</p>
                                <a href="/upgrade" class="btn btn-primary">View Plans</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Optimized Prompt Modal -->
    <div class="modal fade" id="optimizedModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Optimized Prompt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="optimized-text" id="optimizedText"></div>
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-primary flex-fill" onclick="useOptimized()">Use</button>
                        <button class="btn btn-outline-primary" onclick="copyOptimized()">Copy</button>
                        <button class="btn btn-outline-primary" onclick="optimizePrompt()">Retry</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Title Modal -->
    <div class="modal fade" id="editTitleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Edit Title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="editTitleInput">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="saveTitle()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="welcomeModalTitle">Welcome to ChatForge!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="welcomeModalBody">
                    <p>ðŸŽ‰ You've successfully signed in! Here's what you get:</p>
                    <ul>
                        <li>100 free credits daily</li>
                        <li>Access to multiple AI models</li>
                        <li>Chat history saved automatically</li>
                        <li>Personalization options</li>
                    </ul>
                    <p>Start chatting now and explore the power of AI!</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" data-bs-dismiss="modal">Get Started</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div class="modal fade" id="upgradeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="upgradeModalTitle">Message Limit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="upgradeModalBody">
                    <p>Upgrade to continue</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" id="upgradeModalCancel" onclick="startNewChatFromModal()">Start New Chat</button>
                    <button class="btn btn-primary" onclick="goToUpgrade()">Upgrade to Pro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Required Modal -->
    <div class="modal fade" id="authRequiredModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5><i class="fas fa-lock"></i> Login Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This model requires you to be logged in. Sign in or create a free account to access more models!</p>
                    <ul style="color: var(--text-2);">
                        <li>100 free credits daily</li>
                        <li>Access to 11+ AI models</li>
                        <li>Save chat history</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-outline-primary" onclick="goToLogin()">Sign In</button>
                    <button class="btn btn-primary" onclick="goToSignup()">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pro Required Modal -->
    <div class="modal fade" id="proRequiredModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5><i class="fas fa-crown" style="color: #ffd700;"></i> Pro Model</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This is a premium model available only for Pro users. Upgrade now to unlock:</p>
                    <ul style="color: var(--text-2);">
                        <li>Access to 100+ AI models</li>
                        <li>Unlimited messages per chat</li>
                        <li>Priority support</li>
                        <li>Advanced features</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="goToUpgrade()"><i class="fas fa-crown"></i> Upgrade to Pro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5><i class="fas fa-credit-card"></i> Upgrade to Pro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" id="paymentCloseBtn"></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                        <div style="padding: 20px; border: 2px solid var(--border); border-radius: 12px; cursor: pointer;" onclick="selectPlan('monthly', 9.99, this)" class="plan-card">
                            <h6 style="font-weight: 600; margin-bottom: 10px;">Monthly</h6>
                            <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent);">$9.99<span style="font-size: 0.9rem; color: var(--text-2);">/mo</span></div>
                            <p style="color: var(--text-2); font-size: 0.85rem; margin-top: 10px;">30 days access</p>
                        </div>
                        <div style="padding: 20px; border: 2px solid var(--accent); border-radius: 12px; cursor: pointer; position: relative;" onclick="selectPlan('quarterly', 24.99, this)" class="plan-card">
                            <span style="position: absolute; top: -10px; right: 10px; background: var(--accent); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">Save 17%</span>
                            <h6 style="font-weight: 600; margin-bottom: 10px;">Quarterly</h6>
                            <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent);">$24.99<span style="font-size: 0.9rem; color: var(--text-2);">/3mo</span></div>
                            <p style="color: var(--text-2); font-size: 0.85rem; margin-top: 10px;">90 days access</p>
                        </div>
                        <div style="padding: 20px; border: 2px solid var(--border); border-radius: 12px; cursor: pointer; position: relative;" onclick="selectPlan('yearly', 95.99, this)" class="plan-card">
                            <span style="position: absolute; top: -10px; right: 10px; background: #ffd700; color: #000; padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">Save 20%</span>
                            <h6 style="font-weight: 600; margin-bottom: 10px;">Yearly</h6>
                            <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent);">$95.99<span style="font-size: 0.9rem; color: var(--text-2);">/yr</span></div>
                            <p style="color: var(--text-2); font-size: 0.85rem; margin-top: 10px;">365 days access</p>
                        </div>
                    </div>
                    
                    <h6 style="margin-bottom: 15px;">Payment Method</h6>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-outline-primary payment-method-btn active" onclick="selectPaymentMethod('card', this)" style="flex: 1;">
                            <i class="fas fa-credit-card"></i> Card
                        </button>
                        <button class="btn btn-outline-primary payment-method-btn" onclick="selectPaymentMethod('paypal', this)" style="flex: 1;">
                            <i class="fab fa-paypal"></i> PayPal
                        </button>
                        <button class="btn btn-outline-primary payment-method-btn" onclick="selectPaymentMethod('crypto', this)" style="flex: 1;">
                            <i class="fab fa-bitcoin"></i> Crypto
                        </button>
                    </div>
                    
                    <div id="cardPayment">
                        <div class="mb-3">
                            <label>Card Number</label>
                            <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div class="mb-3">
                            <label>Cardholder Name</label>
                            <input type="text" class="form-control" id="cardName" placeholder="John Doe">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>Expiry Date</label>
                                <input type="text" class="form-control" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div>
                                <label>CVV</label>
                                <input type="text" class="form-control" id="cardCvv" placeholder="123" maxlength="3">
                            </div>
                        </div>
                    </div>
                    
                    <div id="paypalPayment" style="display: none;">
                        <div class="mb-3">
                            <label>PayPal Email</label>
                            <input type="email" class="form-control" id="paypalEmail" placeholder="your@email.com">
                        </div>
                    </div>
                    
                    <div id="cryptoPayment" style="display: none;">
                        <div class="mb-3">
                            <label>Wallet Address</label>
                            <input type="text" class="form-control" id="cryptoWallet" placeholder="0x...">
                        </div>
                        <div class="mb-3">
                            <label>Cryptocurrency</label>
                            <select class="form-control" id="cryptoType">
                                <option>Bitcoin (BTC)</option>
                                <option>Ethereum (ETH)</option>
                                <option>USDT</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="payBtn" onclick="processPayment()"><i class="fas fa-lock"></i> Pay <span id="payAmount">$9.99</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Modal -->
    <div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="text-align: center; border: none;">
                <div class="modal-body" style="padding: 50px;">
                    <div class="spinner-border" style="width: 4rem; height: 4rem; color: var(--accent); margin-bottom: 20px;" role="status"></div>
                    <h5 style="font-weight: 600; margin-bottom: 10px;">Processing Payment...</h5>
                    <p style="color: var(--text-2); font-size: 0.9rem;">Please wait while we confirm your payment</p>
                    <div class="progress" style="height: 6px; margin-top: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" style="width: 0%; background: var(--accent);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content" style="text-align: center;">
                <div class="modal-body" style="padding: 40px;">
                    <div style="width: 80px; height: 80px; background: #10a37f; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; animation: scaleIn 0.5s;">
                        <i class="fas fa-check" style="font-size: 3rem; color: #fff;"></i>
                    </div>
                    <h4 style="font-weight: 700; margin-bottom: 10px;">Payment Successful!</h4>
                    <p style="color: var(--text-2);">Welcome to ChatForge Pro! ðŸŽ‰</p>
                    <p style="color: var(--text-2); font-size: 0.9rem;" id="subscriptionInfo">Your subscription is active until <strong id="expiryDate"></strong></p>
                    <p style="color: var(--text-2); font-size: 0.85rem; margin-top: 15px;">Redirecting...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <style>
        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        .selector-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .selector-item.disabled:hover {
            background: transparent;
        }
        .payment-method-btn.active {
            background: var(--accent) !important;
            color: #fff !important;
            border-color: var(--accent) !important;
        }
        @keyframes progressBar {
            0% { width: 0%; }
            100% { width: 100%; }
        }
    </style>
</body>
</html>
